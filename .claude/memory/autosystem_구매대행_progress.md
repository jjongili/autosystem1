# Progress - 진행 이력

## 2026-01-22

### simulator_gui_v3.py 시뮬레이터 UI 완성 작업

#### 프로그램 목적
- **파일**: `simulator_gui_v3.py`
- **목적**: 타오바오/1688 상품을 불사자에서 수집 → 분석 → 검수 → 업로드하는 통합 GUI
- **핵심 기능**:
  1. 상품 수집 (불사자 API 연동)
  2. 안전 검수 (금지 키워드/브랜드 체크)
  3. 옵션 선택 UI (원클릭 A/B/C/D 선택)
  4. 엑셀 저장/로드 (검수 결과 공유용)
  5. 불사자 API 반영 (대표옵션 변경)

#### 현재 작업 상태
- **완료**: 수집 탭에 `8. bulsaja_simulator.py`와 동일한 UI 구조 적용
  - 미끼 키워드 설정 섹션 (🚫)
  - 카테고리별 검수 수준 섹션 (🛡️) - 보통/엄격(AI)/제외
  - 저장 설정 섹션 (💾)
  - 핸들러 함수 추가: `_reset_keywords`, `_save_keywords`, `_open_category_settings`, `_browse_save_path`
  - `_analyze_single_product`에 `check_level` 파라미터 추가

- **진행 중**: 검수 탭 엑셀 로드 시 데이터 표시 문제
  - **문제**: 엑셀 로드 후 썸네일/옵션이 [썸네일] 텍스트로만 표시됨
  - **원인**: 엑셀 저장/로드 컬럼명 불일치
    - 저장 시: "썸네일\n이미지", "옵션\n이미지", "옵션명" 등
    - 로드 시: 다른 컬럼명 기대
  - **수정**: `_parse_excel_data` 함수에서 여러 컬럼명 대체 지원 추가

#### 엑셀 파일 구조 (분석결과 시트)
```
썸네일\n이미지 | 옵션\n이미지 | 상품명 | 안전여부 | 위험사유 |
전체옵션 | 유효옵션 | 최종옵션 | 미끼옵션 | 미끼옵션목록 |
대표옵션 | 선택방식 | 선택 | 옵션명 | 중국어\n옵션명 | 그룹명
```

#### 관련 파일
- `simulator_gui_v3.py` - 메인 GUI 파일
- `8. bulsaja_simulator.py` - 참조용 기존 시뮬레이터
- `bulsaja_common.py` - 공통 API/함수 모듈

---

## 2026-01-21

### 시뮬레이터 업그레이드 계획
- **추가 기능**: 썸네일 OCR로 누끼(배경 제거 이미지) 자동 선택
- **목적**: 대표 옵션 선택 시 누끼 이미지를 자동으로 찾아서 추천
- **파일**: `8. bulsaja_simulator.py`

### 서버 변경사항 문서 작성
- **파일**: `docs/work-plans/2026-01-21_서버변경사항.md`
- 물갈이/리뉴얼대상 판별 조건 정리
- 조건3 수정: "7일 주문 0건" → "7일 연속 유입수 감소"
- 업로드 자동화 API 설계
- WebSocket 실시간 통신 설계

### bulsaja_uploader_server.py 생성
- WebSocket 기반 서버 연동 업로더
- 서버에서 작업 명령 수신 → 진행상황 실시간 보고

### simulator_gui_v3.py 탭 구조 재구성
- **파일**: `simulator_gui_v3.py`
- **변경**: 단일 화면 → 탭 기반 구조 (수집|검수|설정)
- **수집 탭** (업로더 v1.5와 동일한 설정):
  - 그룹 선택 콤보박스
  - 수집조건: 미업로드/수집완료/수정중/검토완료/업로드완료/전체
  - 수집수 설정
  - 옵션 설정: 옵션수, 옵션정렬(가격낮은순/주요가격대/가격높은순), 상품명 처리
  - 가격 필터: 최저가격, 최대가격
  - 체크박스: 미끼옵션 필터링, 썸네일매칭 대표상품, 안전 검수
  - 마진 설정: 환율, 카드수수료, 마진(min,max), 더하기마진, 할인율, 가격단위
  - 진행 상황 로그
- **검수 탭**:
  - 기존 메인 화면 유지
  - 엑셀 로드 → 옵션 클릭 선택 → 불사자 업데이트
  - 컬럼 설정 버튼 유지
- **설정 탭**:
  - 컬럼 선택 체크박스 (카테고리별)
  - 컬럼 순서 조정 (▲▼ 버튼)
  - 기본값 리셋
  - 설정 저장

### simulator_gui_v3.py 상품 검수 및 엑셀 기능 구현
- **참조**: `8. bulsaja_simulator.py` 기존 코드 설계 분석
- **공통 모듈 import 확장**:
  - `load_banned_words`, `load_excluded_words` 추가
  - `check_product_safety` 추가
  - openpyxl 라이브러리 import (Workbook, Font, PatternFill, Alignment 등)
- **상품 분석 기능 (`_analyze_single_product`)**:
  - 상품명 안전 검사 (check_product_safety)
  - 미끼옵션 필터링 (filter_bait_options)
  - 대표옵션 선택 (select_main_option) - 상품명 매칭 → 최저가 폴백
  - 가격 범위 계산 (min/max CNY)
  - 옵션 개수 제한 (설정된 옵션수 적용)
- **엑셀 저장 기능 (`_save_collection_to_excel`, `_save_results_to_excel`)**:
  - **분석결과 시트**: 썸네일/옵션 이미지(=IMAGE 수식), 안전여부(O/X 색상), 선택 컬럼(노란색 배경)
  - **상세정보 시트**: 불사자ID, 최종옵션목록, URL 등 API 반영용 데이터
  - **통계 시트**: 전체/안전/위험/미끼옵션 발견 카운트
  - 열 너비/행 높이 자동 조정
  - 자동 필터 설정
- **ExcelApplier 클래스 추가**:
  - 엑셀 파일 읽기 (상세정보 시트 우선)
  - "선택" 컬럼 파싱 (A, B, C 형태 → 인덱스 변환)
  - 대표옵션 변경 불사자 API 반영 (uploadSkus.main_product)
  - 위험상품 스킵 옵션
- **핵심**: `bulsaja_common.py` 동일 모듈 import로 업로더/시뮬레이터 옵션 선택 기준 동일하게 적용

---

## 2026-01-18

### 불사자 업로더 마켓 ID 매핑 수정
- **문제**: 하드코딩된 마켓 ID(10200)로 업로드하면 엉뚱한 마켓(툴앤퍼니)에 업로드됨
- **원인**: 그룹별로 연결된 마켓 ID가 다름 (예: 03_코드리크 → 스마트스토어 ID: 10488)
- **해결**:
  - `GET /api/market/group/{group_id}/markets` API 발견
  - `get_group_markets(group_id)` 함수 추가 - 그룹 내 마켓 목록 조회
  - `get_market_id_in_group(group_name, market_name)` 함수 추가 - 그룹 내 특정 마켓 ID 조회
  - 캐시 적용으로 중복 API 호출 방지
- **파일**: `7. bulsaja_uploader_v1.1.py`
- **API 구조**:
  - `/api/market/groups/` → 그룹 목록 (name, id, market_count)
  - `/api/market/group/{group_id}/markets` → 그룹 내 마켓 목록 (id, type, account 등)
  - `/api/market/{market_id}/upload/` → 업로드 (market_id는 그룹 ID가 아닌 마켓 ID)

## 2026-01-15

### PPT 기반 검수 기능 업데이트
- **PROHIBITED_KEYWORDS** 대폭 확장 (126개)
  - 무기류: BB탄, 너클, 소음기, 레이저조준기
  - 타정기/전기충격기: 타정총, 타카건, 스턴건
  - 경찰/군용품: 경찰제복, 수갑, 삼단봉
  - 가스/연료: 가스통, 부탄가스, 에어컨냉매
  - 생활화학: 접착제, 페인트, 살충제
  - 의료기기: 통증완화, 디스크완화, 자세교정기

- **BRAND_KEYWORDS** 대폭 확장 (139개)
  - 폰케이스: 케이스티파이
  - 텀블러: 스탠리, 예티, 하이드로플라스크
  - 캠핑: 블랙독, 네이처하이크, 스노우피크
  - 캐리어: 리모와, 투미, 샘소나이트
  - 낚시: 시마노, 다이와
  - 골프: 타이틀리스트, 캘러웨이

- **CHARACTER_KEYWORDS** 신규 추가 (32개)
  - 디즈니, 마블, 포켓몬, 산리오, 뽀로로 등

- **CELEBRITY_KEYWORDS** 신규 추가 (33개)
  - TV: 나혼자산다, 런닝맨, 유퀴즈
  - 유튜버: 빠니보틀, 쯔양, 침착맨
  - 아이돌: BTS, 블랙핑크, 뉴진스

- **KEYWORD_SAFE_CONTEXT_MAP** 확장
  - 특정 브랜드(케이스티파이, 스탠리 등) 빈 set으로 항상 위험 처리

### Hook 기반 메모리뱅크 시스템 구축
- `memory_hook.py` v2.0 업데이트
- Stop Hook 설정 완료

## 2026-01-14

### 완료된 작업
1. **마케팅 분석 로그인 문제 해결**
   - 원인: 잘못된 로그인 버튼 클릭
   - 해결: Enter 키로 로그인 제출
   - 파일: `web_system/modules/marketing_collector.py`

2. **한글 깨짐 수정**
   - Windows UTF-8 인코딩 설정 추가

3. **실시간 로그 추가**
   - `_log()` 함수로 타임스탬프 + flush 출력

4. **썸네일 스크린샷 에러 처리**
   - DOM 체크 로직 추가
   - `server.py:1599-1623`

### 수정된 파일 목록
- `web_system/modules/marketing_collector.py`
- `web_system/server.py`
- `bulsaja_common.py`

## 2026-01-16

### 불사자 자동화 도구 개발 현황 (클로드코드)

#### 완성된 프로그램
1. **`7. bulsaja_uploader_v1.1.py`** - 불사자 대량 업로더
   - 불사자 API 연동 (토큰 자동 추출)
   - 마켓 그룹별 업로드 (스마트스토어/11번가/G마켓/쿠팡)
   - 가격 계산 (환율/마진/카드수수료)
   - 옵션 필터링 (미끼옵션 제외)
   - 대표옵션 자동 선택 (상품명 매칭/썸네일 매칭)
   - 상품명 셔플 (앞 3-4단어 제외)
   - 동시 세션 처리 (병렬 업로드)

2. **`8. bulsaja_simulator.py`** - 시뮬레이터 (학습용)
   - 실제 업로드 없이 분석만 수행
   - 브랜드/지재권/위험상품 검사
   - 미끼옵션 탐지
   - 썸네일-옵션 매칭 분석
   - 결과 엑셀 저장 (IMAGE 수식, 3개 시트)
   - 카테고리별 검수 레벨 설정 (strict/normal/skip)

3. **`9. bulsaja_option_updater.py`** - 옵션 업데이터
   - 시뮬레이션 엑셀 로드
   - 대표옵션 선택(A/B/C) 불사자 반영
   - 미끼옵션 SKU 삭제
   - 상품 재활용 워크플로우 지원

4. **`bulsaja_common.py`** - 공통 모듈
   - BulsajaAPIClient 클래스
   - 토큰 추출 함수
   - 미끼옵션 필터링
   - 대표옵션 선택 로직
   - 안전 검수 (금지 키워드 체크)

#### 키워드 검수 시스템 고도화
- [12:25:22] PPT 지재권 위험 리스트 기반 키워드 대폭 업데이트
- [12:25:34] 시뮬레이션 오탐 20개→0개 수정 (안전컨텍스트 추가)
- [12:25:41] Excel 출력 형식 개선 - IMAGE 수식, A/B/C 옵션 정리
- [12:26:xx] 시뮬레이션 엑셀 '선택' 컬럼 추가 (노란색 배경)
- [12:27:xx] 동물학대 도구 키워드 추가
- [12:28:xx] 어망/그물 안전컨텍스트에서 어획관련 제거

5. **`10. esm_manager_gui.py`** - ESM Plus 상품 관리 (PyQt5)
   - Selenium JavaScript fetch로 API 호출
   - 브라우저 세션 직접 사용 (쿠키 공유)
   - 상품 조회/삭제 기능
   - 2차 인증 수동 처리 필요

6. **`10. esm_manager_auto_v0.2.py`** - ESM 자동 삭제
   - 계정 리스트 자동 로그인
   - 전체 상품 자동 삭제 (판매중지 → 삭제)
   - 무인 실행 가능 (2차 인증 제외)

#### 마켓별 자동 로그인 구현 현황

| 마켓 | 자동 로그인 | 2차 인증 | 비고 |
|------|------------|---------|------|
| 스마트스토어 | ✅ 완료 | SMS API 연동 | marketing_collector.py |
| 11번가 | ✅ 완료 | - | client 프로그램 |
| G마켓/옥션(ESM) | ⚠️ 부분 | 수동 처리 | esm_manager |
| 쿠팡 | ❌ 미구현 | - | 추후 개발 |

#### 워크플로우
```
[타오바오 수집] → [불사자 상품관리]
       ↓
[시뮬레이터] → 분석 엑셀 생성
       ↓
[사용자 검토] → 선택 컬럼 수정 (A/B/C)
       ↓
[옵션 업데이터] → 선택 반영 + 미끼 삭제
       ↓
[업로더] → 마켓 업로드
```

#### 2차 인증 버튼 클릭 문제 수정 (17:xx)
- **문제**: 인증버튼 클릭 후 팝업 확인 버튼 클릭 안됨
- **원인**: 브라우저 콘솔 디버깅으로 정확한 클래스명 확인
  - 팝업 확인 버튼: `PopupCommon_btn__FhbVj` (대문자 F 중요!)
  - 최종 확인 버튼: `Button_btn__wNWXt Button_btn_plain__vwFfm`
- **수정**: `marketing_collector.py` `_handle_2fa()` 함수
  - 팝업 처리 JavaScript에 정확한 클래스명 추가 (341-381줄)
  - 최종 확인 버튼 JavaScript 개선 (437-476줄)
