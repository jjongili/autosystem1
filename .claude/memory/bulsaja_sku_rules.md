# 불사자 SKU/옵션 수정 규칙 (절대 준수)

## 절대 수정 금지 필드
다음 필드들은 **절대로 건드리면 안됨**. 잘못 수정하면 모든 상품이 망가질 수 있음.

| 필드 | 설명 | 이유 |
|------|------|------|
| `exclude` | 옵션 제외 여부 | 조합형 옵션 vid↔id 매핑 깨짐 |
| `id` | 조합형 옵션 ID (예: "1:1", "2:3") | 옵션 매트릭스 구조 |
| `skuRef` | SKU 참조 ID | 상품 식별자 |
| `urlRef` | 이미지 URL | 원본 데이터 |
| `stock` | 재고 | 원본 데이터 |
| `_origin_price` | 위안 원가 | 원본 가격 (CNY) |
| `text` | 한글 옵션명 (A., B. 접두사) | 번역된 옵션명 |
| `_text` | 중국어 원본 옵션명 | 원본 데이터 |

## 수정 가능한 필드 (4개만)
| 필드 | 설명 | 용도 |
|------|------|------|
| `origin_price` | 원화 원가 (KRW) | 가격 계산 결과 |
| `sale_price` | 원화 판매가 (KRW) | 가격 계산 결과 |
| `main_product` | 대표상품 여부 | true/false - 최저가 옵션에만 true |

## 올바른 처리 방식

### 1. 미끼 옵션 필터링
- 미끼 옵션 ID 목록 추출
- **exclude 건드리지 않음**
- 선택할 옵션 ID만 기록

### 2. 가격 계산
- **모든 옵션**에 대해 가격 계산
- `origin_price`, `sale_price`만 업데이트
- exclude된 옵션도 가격 계산 필요

### 3. 대표상품 설정
- **전체 옵션 중 위안원가 최저가** 찾기 (exclude 무시!)
- 불사자가 exclude=true 해도 우리는 전체 옵션에서 대표상품 선택
- 해당 옵션만 `main_product: true`
- 나머지는 `main_product: false`

## 잘못된 예시 (절대 금지)
```python
# 이렇게 하면 안됨!!!
for sku in upload_skus:
    if sku['id'] not in selected_ids:
        sku['exclude'] = True  # 절대 금지!
```

## 올바른 예시
```python
# 이렇게 해야 함
for sku in upload_skus:
    # exclude는 건드리지 않음
    origin_cny = sku.get('_origin_price', 0)
    origin_krw, sale_price, _, _ = calculate_price(origin_cny, settings)
    sku['origin_price'] = origin_krw
    sku['sale_price'] = sale_price
    sku['main_product'] = False

# 최저가 옵션만 대표상품
if min_price_idx >= 0:
    upload_skus[min_price_idx]['main_product'] = True
```

## 불사자 UI 동작 방식
- "최저 옵션가 기준범위 적용" 버튼 클릭 시:
  - 최저가 옵션 선택
  - 50% 범위 내 옵션 자동 선택
  - **모든 옵션 exclude: false 유지**
  - 모든 옵션 가격 계산됨
  - main_product만 다름

## 마켓 정책 (중요)

### 가격 범위 정책 (150% 규칙)
- **쿠팡 제외** 모든 플랫폼 (스마트스토어, 11번가, G마켓/옥션 등)
- 대표옵션(main_product) 가격 기준 **50% ~ 150%** 범위만 허용
- 범위 밖 옵션은 마켓에서 등록 거부됨

**중요: 스마트스토어는 할인 전 금액 기준!**
- 스마트스토어: **할인 전 금액(origin_price)** 기준으로 150% 판단
- 불사자 버그: 할인 후 금액(sale_price)으로 판단함 → 주의 필요

**예시:**
- 대표옵션 할인전 가격: 10,000원
- 허용 범위: 5,000원 ~ 15,000원 (할인 전 기준)
- 이 범위 밖 옵션은 업로드 실패

**불사자 UI 표기:**
- "위아래 50%" 라고 표기하지만 수식상 50%~150% 범위가 맞음
- 이 범위 안에서 옵션 개수 제한 적용

### 옵션 구조 정책
- **모든 옵션에 가격이 있어야 함**
- 옵션을 제외하면 조합형 옵션 매트릭스가 깨짐
- 그래서 불사자는 모든 옵션 유지 + 가격 계산 후 업로드

**우리 프로그램 역할 (순서대로):**
1. 미끼 옵션 **식별** (키워드 + 가격 클러스터 기반)
   - 키워드 매칭: "선물", "사은품" 등 미끼 키워드
   - 가격 클러스터: 저가그룹 vs 주가격대 분리 (30% 미만이면 미끼)
2. 대표 옵션 선택 → `main_product: true`
   - **전체 옵션 중 위안원가 최저가** (exclude 무시!)
   - 불사자가 exclude=true 해도 우리가 대표상품 선택
3. 대표옵션 기준 150% 범위 내 옵션 필터링 (쿠팡 제외)
4. **옵션 개수 제한**: 사용자가 10개로 설정하면
   - 대표옵션 기준 가격 낮은 순서로 정렬
   - 상위 10개만 선택
5. 선택된 옵션만 유효 처리, 나머지는 제외

**필터링 로그 출력:**
- 🚫 불사자제외: exclude=true인 옵션 (마켓에 안 올라감)
- 🔍 키워드제외: 미끼 키워드 매칭된 옵션
- 💰 가격제외: 최소/최대 가격 범위 밖 옵션
- 📊 가격클러스터 미끼제거: 저가그룹으로 판단된 옵션

**옵션 선택 예시:**
- 전체 옵션: 50개
- 미끼 제거 후: 40개
- 150% 범위 내: 25개
- 개수 제한 10개 → 대표옵션 기준 가격 낮은 순 10개 선택

**미끼라고 `exclude: true` 하면 안됨** - 마켓 정책상 옵션 구조 깨짐

## 경고
SKU 필드를 잘못 수정하면:
1. 조합형 옵션 생성 실패
2. 상품 판매가 0원
3. 상품 수정 불가
4. **모든 상품 사용 불가능**

## 가격 클러스터링 (미끼 탐지)
```
옵션이 20~40위안에 3개, 200~300위안에 4개 있을 때
→ 전체 평균으로 계산하면 문제 발생
→ 그룹으로 나눠서 가격 비교

저가그룹: 20~40위안 (3개, 43%)
주가격대: 200~300위안 (4개, 57%)
가격갭: 5배 이상 → 저가그룹이 30% 미만이면 미끼로 판단
```

**가격 클러스터링 조건:**
- 저가그룹과 주가격대 사이 가격갭이 1.5배 이상
- 저가그룹 옵션 비율이 30% 미만
- 위 조건 모두 충족 시 저가그룹을 미끼로 제거

---
마지막 업데이트: 2026-01-19
사유: 대표옵션 선택 시 exclude 무시, 가격 클러스터링 규칙 추가, 카테고리 구조 문서화
