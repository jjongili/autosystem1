# 구매대행 자동화 시스템 - 프로젝트 현황 및 개발 지시서

**작성일**: 2026-01-16
**작성자**: 클로드코드 (프로젝트 기획자)
**수신자**: 안티그래비티 (제미나이, 개발자)

---

## 📊 프로젝트 전체 현황

### 시스템 구조

```
autosystem1/
│
├── 🌐 web_system/              ← 통합관리 웹서버 (FastAPI)
│   ├── server.py               ← 메인 서버 (8000+ 라인)
│   └── modules/
│       ├── marketing_collector.py ← 마케팅 데이터 수집 (진행중 60%)
│       ├── daily_sync.py
│       └── ...
│
├── 🔥 불사자 자동화 (클로드코드 개발) - 완성
│   ├── 7. bulsaja_uploader_v1.1.py   ✅ 대량 업로더
│   ├── 8. bulsaja_simulator.py       ✅ 시뮬레이터 (학습용)
│   ├── 9. bulsaja_option_updater.py  ✅ 옵션 업데이터
│   └── bulsaja_common.py             ✅ 공통 모듈
│
├── 📦 ESM(G마켓/옥션) 자동화
│   ├── 10. esm_manager_gui.py        ✅ 상품 관리 (2차인증 수동)
│   └── 10. esm_manager_auto_v0.2.py  ✅ 자동 삭제
│
└── 📝 .claude/memory/           ← 메모리뱅크
```

---

## ✅ 완성된 기능

### 1. 핵심 인프라 (100%)
- FastAPI 웹서버 (server.py)
- Google Sheets API 연동
- 로그인/권한 시스템 (admin/operator/viewer)
- WebSocket 실시간 통신
- Chrome Extension 자동 로그인 + Client 프로그램

### 2. 계정 관제센터 (100%)
- 100개+ 스마트스토어 계정 통합 모니터링
- 계정 상태 자동 감지 (정상/주의/경고/정지)
- 필터링 (소유자/용도/상태/매출/주문 계급)

### 3. SMS 자동화 (100%)
- Google Messages Web 연동
- 인증번호 자동 추출/입력
- 3개 폰 번호 관리

### 4. 매출 관리 (100%)
- 일일 매출 장부
- TOP 40 상품 분석
- 소유자별/용도별 매출 집계

### 5. 올인원 자동화 (100%)
- 등록갯수 조회, 배송코드 조회/변경
- 상품삭제, 혜택설정, 중복삭제
- 병렬 처리 (4개 워커)

### 6. 불사자 도구 (100%)
- 대량 업로더 (v1.1)
- 시뮬레이터 (학습용)
- 옵션 업데이터
- 공통 모듈

---

## 🔄 진행 중인 기능

### 마케팅 분석 (60%)

**파일**: `web_system/modules/marketing_collector.py`

**완료된 부분**:
- 스마트스토어 로그인 (Enter 키 제출)
- SMS 2차 인증 자동 처리 (서버 API 연동)
- 비즈어드바이저 상품노출성과 수집
- 전체채널 데이터 수집 (신규 추가)
- 쇼핑파트너센터 클릭리포트 수집
- 쇼핑몰 정보 수집 (등급, 클린위반 등 추가)
- Google Sheets 저장 (A~G, I열~, Q열~, S열~ 레이아웃)

**해결해야 할 문제**:
1. 비즈어드바이저 iframe 전환 불안정
2. 2차 인증 버튼 클릭 최적화 (휴대전화 섹션 우선 탐색으로 수정됨)
3. 로그인 타임아웃 시 강제 이동 전략 추가됨

---

## 📋 마켓별 자동 로그인 구현 현황

| 마켓 | 자동 로그인 | 2차 인증 | 담당 파일 | 상태 |
|------|------------|---------|----------|------|
| **스마트스토어** | ✅ | SMS API 자동 | marketing_collector.py | 60% (안정화 필요) |
| **11번가** | ✅ | - | client 프로그램 | 완성 |
| **G마켓/옥션(ESM)** | ⚠️ | 수동 처리 | esm_manager*.py | 완성 |
| **쿠팡** | ❌ | - | 미구현 | 추후 개발 |

---

## 🎯 안티그래비티 작업 지시

### Phase 1: 마케팅 분석 안정화 (최우선)

#### 1.1 로그인 테스트
```bash
cd web_system
python -m modules.marketing_collector
```

**확인사항**:
- [ ] ID/PW 입력 정상 여부
- [ ] Enter 키 로그인 제출 동작
- [ ] 2차 인증 SMS 수신 및 입력
- [ ] 로그인 성공 후 대시보드 진입

#### 1.2 비즈어드바이저 iframe 확인
- 현재 `iframe#__delegate` 또는 첫 번째 iframe 시도
- 실패 시 `web_system/runtime/smartstore_debug/` 폴더에 스크린샷 저장됨
- DOM 구조 변경 여부 확인 필요

#### 1.3 전체채널 데이터 수집 (신규 추가됨)
- `collect_channel_data()` 함수 추가됨
- 채널명, 유입수 데이터 수집
- S열~에 저장

#### 1.4 쇼핑파트너센터 수집 검증
- 상품클릭리포트 (노출/클릭/전환)
- 쇼핑몰 정보 (ID, 명, 타입, 등급, 클린위반 등)

---

### Phase 2: 물갈이 알림 시스템 (다음 단계)

**교육자료 기반 판단 기준**:
```python
REFRESH_CONDITIONS = {
    "등록_경과일": 60,           # 등록 후 60일 이상
    "주간_유입_감소율": 0.2,     # 20% 이상 감소
    "클릭률_기준": 0.01,         # 1% 이하
    "최근_판매": 0               # 7일 내 판매 0건
}

EXCLUDE_CONDITIONS = {
    "리뷰_있음": True,           # 리뷰 있는 상품 보호
    "최근_판매_이력": 7          # 7일 내 판매 있으면 제외
}
```

**필요 작업**:
- [ ] 마케팅 데이터 + Commerce API 조인
- [ ] 물갈이 대상 자동 필터링 로직
- [ ] 알림 UI (관제센터 탭 추가)

---

### Phase 3: 클린위반 모니터링

**수집 위치**: 쇼핑파트너센터 > 정보관리 > 클린위반현황

**위반 유형**:
| 유형 | 설명 | 자동 대응 |
|------|------|----------|
| 취급불가상품 | 의료기기표현, 살충제 등 | 삭제 권고 |
| 상품명표기기준 | 모음전, 가격어뷰징 | 수정 알림 |
| 지재권침해 | 브랜드/캐릭터 | 즉시 삭제 |
| 해외구매대행고지미흡 | 고지문구 누락 | 템플릿 제공 |

---

### Phase 4: 쿠팡 자동 로그인

**현재 상태**: 미구현

**참고**:
- 스마트스토어 로그인 로직 참고
- 쿠팡은 2차 인증 방식이 다를 수 있음

---

## 📁 불사자 자동화 워크플로우 (참고)

```
[타오바오 수집] → [불사자 상품관리]
       ↓
[시뮬레이터] → 분석 엑셀 생성 (브랜드/미끼옵션 검수)
       ↓
[사용자 검토] → '선택' 컬럼 수정 (A/B/C)
       ↓
[옵션 업데이터] → 불사자에 반영 + 미끼 삭제
       ↓
[업로더] → 마켓별 대량 업로드
```

---

## 🚨 긴급 수정 지시 (2026-01-16 추가)

### Chrome 프로필 충돌 문제

**안티그래비티 제안**:
> "크롬이 이미 열려있으면 안내 메시지를 띄우겠습니다"

**기획자 피드백**: ❌ **잘못된 접근**

사용자가 서버를 상시 모니터링하지 않습니다. "창을 닫아주세요" 메시지는 무의미합니다.

### 올바른 해결 방안

**방법 1: 기존 크롬에 연결해서 바로 시작**
```python
# 이미 열린 크롬이 있으면 해당 세션에 연결
from selenium.webdriver.chrome.options import Options
options = Options()
options.add_experimental_option("debuggerAddress", "127.0.0.1:9222")
driver = webdriver.Chrome(options=options)
```

**방법 2: 기존 크롬 강제 종료 후 새로 시작**
```python
import subprocess
# 기존 크롬 프로세스 종료
subprocess.run(["taskkill", "/F", "/IM", "chrome.exe"], capture_output=True)
time.sleep(2)
# 새 크롬 시작
driver = webdriver.Chrome(options=options)
```

**방법 3: 별도 프로필 사용**
```python
# 마케팅 수집 전용 프로필 (충돌 방지)
profile_dir = os.path.join(os.path.dirname(__file__), "..", "runtime", "marketing_chrome_profile")
options.add_argument(f"--user-data-dir={profile_dir}")
```

### 권장 구현

1. **우선**: 방법 3 (별도 프로필) - 가장 안전
2. **대안**: 방법 1 (기존 연결) - 이미 로그인된 세션 활용 가능
3. **최후**: 방법 2 (강제 종료) - 다른 작업 방해 가능성

**핵심**: 사용자에게 "닫아달라"고 요청하지 말고, **프로그램이 알아서 처리**해야 함

---

## ✅ 구현계획서 검토 결과 (2026-01-16 15:30)

### 안티그래비티 제출 구현계획

| 항목 | 계획 내용 | 기획자 판정 |
|------|----------|------------|
| Chrome 프로필 분리 | `marketing_chrome_profile` 전용 사용 | ✅ **승인** |
| iframe 전환 강화 | 대기시간 + 예외처리 보강 | ✅ **승인** |
| 강제 이동 제거 | 정석적 흐름 유지 | ✅ **승인** |

### 기획자 추가 지시사항

#### 1. 프로필 경로 확인 (필수)
```python
# 현재 코드에서 profile_dir 설정 확인
profile_dir = os.environ.get("SMARTSTORE_CHROME_PROFILE_DIR", "").strip()
if not profile_dir:
    # 기존: chrome_profile (다른 프로그램과 충돌 가능)
    # 변경: marketing_chrome_profile (전용)
    profile_dir = os.path.join(os.path.dirname(__file__), "..", "runtime", "marketing_chrome_profile")
```

**주의**: 환경변수 `SMARTSTORE_CHROME_PROFILE_DIR`가 설정되어 있으면 그걸 우선 사용하므로, 기본값만 바꿔서는 안 됩니다.

#### 2. 프로필 충돌 시 자동 복구 로직 추가 (권장)
```python
def connect_chrome(self):
    """Chrome 연결 - 충돌 시 자동 복구"""
    try:
        # 1차 시도: 전용 프로필로 시작
        return self._start_chrome_with_profile("marketing_chrome_profile")
    except Exception as e:
        if "session not created" in str(e).lower() or "user data directory" in str(e).lower():
            print(f"  [WARN] 프로필 충돌 감지, 임시 프로필로 재시도...")
            # 2차 시도: 타임스탬프 기반 임시 프로필
            temp_profile = f"marketing_temp_{int(time.time())}"
            return self._start_chrome_with_profile(temp_profile)
        raise
```

#### 3. 수집 완료 후 브라우저 정리 (필수)
```python
# collect_multiple_accounts 끝부분에서
finally:
    try:
        if self.driver:
            self.driver.quit()
            print("[OK] 브라우저 정상 종료")
    except:
        pass
```

#### 4. 테스트 체크리스트 보완

**Phase 1 테스트 (로그인)**:
- [ ] 크롬 창이 이미 열려있는 상태에서 실행 → 충돌 없이 새 창 생성 확인
- [ ] ID/PW 입력 정상 여부
- [ ] Enter 키 로그인 제출 동작
- [ ] 2차 인증 SMS 수신 및 입력
- [ ] 로그인 성공 후 대시보드 진입

**Phase 2 테스트 (데이터 수집)**:
- [ ] 비즈어드바이저 iframe 진입 성공
- [ ] 상품노출성과 테이블 파싱
- [ ] 전체채널 데이터 수집
- [ ] 쇼핑파트너센터 새 창 열기/닫기
- [ ] 쇼핑몰 정보 (등급, 클린위반) 수집

**Phase 3 테스트 (저장)**:
- [ ] Google Sheets 저장 성공
- [ ] A~G열 (마케팅), I열~ (클릭리포트), Q열~ (몰정보), S열~ (전체채널) 확인

### 승인 및 진행 지시

**구현계획 승인합니다.** 다음 순서로 진행하세요:

1. `marketing_collector.py` 수정
   - `connect_chrome()` 함수에서 프로필 경로 `marketing_chrome_profile`로 변경
   - 프로필 충돌 시 임시 프로필 자동 생성 로직 추가

2. 테스트 실행
   - 크롬 창 열린 상태에서 테스트 → 충돌 없이 동작 확인

3. 결과 보고
   - 각 단계별 성공/실패 로그 공유
   - 스크린샷 필요 시 `smartstore_debug/` 폴더 확인

---

## 📌 중요 참고사항

### 디버그 방법
- 로그인 실패 시: `web_system/runtime/smartstore_debug/` 폴더 확인
- 실시간 로그: `_log()` 함수로 타임스탬프 출력

### 환경 변수
```
SPREADSHEET_KEY           # 메인 스프레드시트
MARKETING_SPREADSHEET_KEY # 마케팅 전용 시트
SERVICE_ACCOUNT_JSON      # Google API 인증
API_KEY                   # 서버 API 키
```

### 브라우저 자동화 주의사항
- 네이버는 자동화 탐지가 강함 → headless 모드 사용 금지
- 로그인 실패 시 캡차 발생 가능 → 수동 개입 필요할 수 있음
- 2차 인증(SMS)은 서버 API로 자동 처리됨

---

## 📞 진행 상황 보고

작업 진행 시 다음 내용을 공유해 주세요:

1. **테스트 결과**: 각 단계별 성공/실패 로그
2. **발견한 문제**: 셀렉터 변경, API 오류 등
3. **해결 방안**: 수정한 코드 내용
4. **다음 단계**: 완료 후 진행할 작업

---

*작성: 클로드코드 (프로젝트 기획자)*
