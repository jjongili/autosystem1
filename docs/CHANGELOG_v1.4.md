# 불사자 업로더 v1.4 변경 이력

> 최종 업데이트: 2026-01-20

---

## 2026-01-20 수정 사항

### 1. [치명적 버그 수정] origin_price 계산 오류

**문제**: `origin_price`에 원화원가만 넣어서 **배송비+마진이 누락**됨
- 기준판매가 85,700원으로 표시 → 실제 159,300원이어야 함
- 예상 순마진 -8,492원 (역마진 발생)

**원인**:
```python
# 잘못된 코드
sku['origin_price'] = int(origin_krw)  # 원화원가만 (배송비/마진 미포함)
```

**수정**:
```python
# 올바른 코드
sku['origin_price'] = int(origin_price_final)  # 정상가 (배송비+마진 포함)
sku['sale_price'] = int(sale_price_final)      # 최종 판매가
```

**가격 필드 정의**:
| 필드 | 설명 | 값 |
|------|------|------|
| `_origin_price` | 위안 원가 (수정 금지) | 235 CNY |
| `origin_price` | 정상가 (할인전, 배송비+마진 포함) | 159,300원 |
| `sale_price` | 판매가 (할인후) | 127,440원 |

---

### 2. 미끼 키워드 공통 판단 로직 추가

**기능**: 미끼 키워드가 2개 이상 옵션에 포함되고, 해당 옵션들 가격이 정상가격이면 → 상품 특성으로 간주

**조건**:
1. 키워드가 **2개 이상 옵션**에 포함
2. 해당 옵션들의 평균 가격이 **전체 평균의 50% 이상**

**예시**:
```
전체 10개 옵션, 평균가 100위안

"맞춤" 포함: 5개 옵션, 평균 95위안 (≥50위안)
  → 통과! "맞춤"으로 필터링 안 함

"사은품" 포함: 3개 옵션, 평균 15위안 (<50위안)
  → 유지! "사은품" 옵션은 미끼로 제외
```

**수정 파일**:
- `7. bulsaja_uploader_v1.4.py`
- `bulsaja_common.py` (filter_bait_options 함수)

---

### 3. 로그 개선

**변경 사항**:

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 진행 로그 | `U01ABC123` | `캠핑 접이식 의자 (U01ABC123)` |
| 이미 업로드됨 | ID만 표시 | 상품명 포함 |
| SKU 없음 | 로그 없음 | `⏭️ [1/100] 상품명 - SKU 없음` |
| 대표상품 | `위안원가 235.0위안` (중복) | `👑 대표: 159,300원` |
| 공통키워드 | 없음 | `ℹ️ 공통키워드 통과: 맞춤 (2개+ 옵션, 정상가격)` |

---

### 4. 완료 시 실패 ID 리스트 출력

**출력 예시**:
```
==================================================
📊 업로드 완료
   ✅ 성공: 8개
   ❌ 실패: 2개
   ⏭️ 건너뜀: 0개

❌ 실패 목록 (2개):
   - U01ABC123 (캠핑 접이식 의자)
   - U01DEF456 (스테인리스 보온병)
==================================================
```

---

### 5. 중복 SKU append 버그 수정

**문제**: `unique_skus.append(sku)`가 2번 호출되어 SKU 중복 추가됨

**수정**: 중복 코드 제거

---

## 가격 계산 공식 (정리)

```
1단계: 원화 환산
    원화원가 = 위안원가(_origin_price) × 환율

2단계: 정상가 (origin_price) - 배송비 포함!
    base_price = 원화원가 + 원화원가 × (카드수수료% + 마진율%) + 정액마진 + 해외배송비
    origin_price = ceil(base_price / 올림단위) × 올림단위

3단계: 판매가 (sale_price)
    sale_price = origin_price × (1 - 할인율%)
    sale_price = ceil(sale_price / 올림단위) × 올림단위
```

**주의**: `해외배송비`는 불사자 API의 `uploadOverseaDeliveryFee` 값 사용

---

## 수정된 파일 목록

1. `7. bulsaja_uploader_v1.4.py`
   - origin_price 계산 수정 (line 1299)
   - 미끼 키워드 공통 판단 로직 (line 1229~1257)
   - 로그 개선 (여러 곳)
   - 실패 ID 리스트 출력 (line 1992~1997)
   - 중복 append 버그 수정

2. `bulsaja_common.py`
   - filter_bait_options() 함수에 공통 키워드 로직 추가 (line 1619~1647)
