<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">
    <title>Pconomy ÏÉÅÌíàÍ∞àÏù¥</title>
    <link rel="manifest"
        href="data:application/json,{'name':'Pconomy','short_name':'Pconomy','start_url':'.','display':'standalone','background_color':'%230a0a0f','theme_color':'%23f97316'}">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-card-hover: #222230;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        html {
            height: -webkit-fill-available;
        }

        .dashboard {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 22px;
            font-weight: 900;
        }

        .header h1 .logo {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            font-size: 11px;
            color: var(--accent-green);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .time-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 6px 10px;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        /* Stage Tabs - Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ */
        .stage-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .stage-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .stage-tabs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .stage-tab {
            flex-shrink: 0;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .stage-tab:hover,
        .stage-tab.active {
            background: var(--bg-card-hover);
            border-color: var(--accent-orange);
        }

        .stage-tab.active {
            border-color: var(--accent-orange);
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.3);
        }

        .stage-tab .name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stage-tab .count {
            font-size: 16px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stage-tab:nth-child(1) .count {
            color: var(--accent-cyan);
        }

        .stage-tab:nth-child(2) .count {
            color: var(--accent-green);
        }

        .stage-tab:nth-child(3) .count {
            color: var(--accent-yellow);
        }

        .stage-tab:nth-child(4) .count {
            color: var(--accent-red);
        }

        .stage-tab:nth-child(5) .count {
            color: var(--accent-purple);
        }

        .stage-tab:nth-child(6) .count {
            color: var(--accent-blue);
        }

        .stage-tab:nth-child(7) .count {
            color: var(--text-secondary);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 36px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
        }

        .filter-pills {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filter-pill {
            flex-shrink: 0;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-pill.active {
            background: var(--accent-orange);
            color: #000;
            border-color: var(--accent-orange);
        }

        /* PC: ÌÖåÏù¥Î∏î Î∑∞ */
        .table-view {
            display: block;
        }

        .table-header {
            display: grid;
            grid-template-columns: 180px repeat(6, 1fr) 150px;
            gap: 2px;
            margin-bottom: 2px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
        }

        .table-header-cell {
            padding: 12px 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            border-right: 1px solid var(--border-color);
        }

        .table-header-cell:last-child {
            border-right: none;
        }

        .table-header-cell:first-child {
            text-align: left;
            padding-left: 14px;
        }

        .table-body {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: calc(100vh - 320px);
            overflow-y: auto;
        }

        .table-row {
            display: grid;
            grid-template-columns: 180px repeat(6, 1fr) 150px;
            gap: 2px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.15s;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:hover {
            background: rgba(249, 115, 22, 0.03);
        }

        .account-cell {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-secondary);
        }

        .account-logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .account-logo.naver {
            background: #03C75A;
        }

        .account-logo.coupang {
            background: #E04D39;
        }

        .account-logo.gmarket {
            background: #4285F4;
        }

        .account-logo.st11 {
            background: #FF5722;
        }

        .account-info h4 {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .account-info span {
            font-size: 10px;
            color: var(--text-muted);
        }

        .cycle-badge {
            display: inline-flex;
            padding: 2px 6px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid var(--accent-purple);
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
            color: var(--accent-purple);
            font-family: 'JetBrains Mono', monospace;
        }

        .cycle-badge.many {
            background: rgba(236, 72, 153, 0.2);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .stage-cell {
            padding: 8px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stage-indicator {
            width: 100%;
            height: 100%;
            min-height: 50px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px;
        }

        .stage-indicator.inactive {
            opacity: 0.2;
        }

        .stage-indicator.completed {
            background: transparent;
            opacity: 0.15;
        }

        .stage-indicator.active {
            background: rgba(249, 115, 22, 0.15);
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
            }

            50% {
                box-shadow: 0 0 25px rgba(249, 115, 22, 0.5);
            }
        }

        .stage-indicator .icon {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .stage-indicator.active .icon {
            animation: iconPulse 1.5s ease-in-out infinite;
        }

        @keyframes iconPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }
        }

        .stage-indicator .value {
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        .stage-indicator.active .value {
            color: var(--accent-orange);
            font-weight: 600;
        }

        .stage-indicator.completed .value {
            color: var(--text-muted);
        }

        .operation-days {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operation-days:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .operation-days.warning {
            background: #fff3cd;
            color: #856404;
        }

        .operation-days.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .operation-days-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .progress-bar {
            width: 80%;
            height: 3px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-orange);
            border-radius: 2px;
        }

        /* Revenue Cell */
        .revenue-cell {
            padding: 8px 10px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .revenue-header-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .revenue-current {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .revenue-target {
            color: var(--text-muted);
        }

        .revenue-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .revenue-bar-fill {
            height: 100%;
            border-radius: 4px;
        }

        .revenue-bar-fill.achieved {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
        }

        .revenue-bar-fill.warning {
            background: linear-gradient(90deg, var(--accent-yellow), var(--accent-orange));
        }

        .revenue-bar-fill.danger {
            background: linear-gradient(90deg, var(--accent-red), var(--accent-pink));
        }

        .revenue-percent {
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
            margin-top: 4px;
        }

        .revenue-percent.achieved {
            color: var(--accent-green);
        }

        .revenue-percent.warning {
            color: var(--accent-yellow);
        }

        .revenue-percent.danger {
            color: var(--accent-red);
        }

        .gali-tag {
            display: inline-block;
            padding: 2px 5px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--accent-red);
            border-radius: 4px;
            font-size: 8px;
            color: var(--accent-red);
            margin-left: 4px;
        }

        /* Î™®Î∞îÏùº: Ïπ¥Îìú Î∑∞ */
        .card-view {
            display: none;
        }

        .account-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .card-header .account-logo {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }

        .card-header .account-info {
            flex: 1;
        }

        .card-header .account-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .card-header .account-info span {
            font-size: 11px;
            color: var(--text-muted);
        }

        .card-stage {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-stage-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-stage-icon.active {
            background: rgba(249, 115, 22, 0.15);
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
            animation: glow 2s ease-in-out infinite;
        }

        .card-stage-info {
            flex: 1;
        }

        .card-stage-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .card-stage-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-orange);
        }

        .card-stage-value.days {
            color: var(--accent-green);
        }

        .card-stage-value.days.warning {
            color: var(--accent-yellow);
        }

        .card-stage-value.days.danger {
            color: var(--accent-red);
        }

        .card-progress {
            flex: 1;
        }

        .card-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }

        .card-progress-bar-fill {
            height: 100%;
            background: var(--accent-orange);
            border-radius: 3px;
        }

        .card-revenue {
            padding: 12px 14px;
        }

        .card-revenue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-revenue-title {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .card-revenue-value {
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .card-revenue-bar {
            width: 100%;
            height: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            overflow: hidden;
        }

        .card-revenue-bar-fill {
            height: 100%;
            border-radius: 5px;
        }

        .card-revenue-bar-fill.achieved {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
        }

        .card-revenue-bar-fill.warning {
            background: linear-gradient(90deg, var(--accent-yellow), var(--accent-orange));
        }

        .card-revenue-bar-fill.danger {
            background: linear-gradient(90deg, var(--accent-red), var(--accent-pink));
        }

        .card-revenue-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            font-size: 11px;
        }

        .card-revenue-target {
            color: var(--text-muted);
        }

        .card-stages-mini {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .mini-stage {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-primary);
        }

        .mini-stage.completed {
            background: var(--text-muted);
            opacity: 0.3;
        }

        .mini-stage.active {
            background: var(--accent-orange);
            animation: miniPulse 1.5s ease-in-out infinite;
        }

        @keyframes miniPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 1024px) {
            .table-view {
                display: none;
            }

            .card-view {
                display: block;
            }

            .dashboard {
                padding: 16px;
            }

            .header h1 {
                font-size: 18px;
            }

            .time-badge {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                padding: 12px;
            }

            .header {
                margin-bottom: 14px;
                padding-bottom: 12px;
            }

            .header h1 {
                font-size: 16px;
            }

            .header-subtitle {
                font-size: 10px;
            }

            .stage-tab {
                padding: 8px 12px;
                min-width: 70px;
            }

            .stage-tab .name {
                font-size: 10px;
            }

            .stage-tab .count {
                font-size: 14px;
            }

            .search-box input {
                padding: 10px 12px 10px 32px;
                font-size: 14px;
            }

            .filter-pill {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        /* ÏïàÏ†ÑÏòÅÏó≠ (ÎÖ∏Ïπò Îì±) */
        @supports (padding: max(0px)) {
            .dashboard {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div>
                <h1>üí∞ <span class="logo">Pconomy</span></h1>
                <div class="header-subtitle">ÏóÖÎ°úÎìú ‚Üí Ïö¥ÏòÅ ‚Üí Î¶¨Îâ¥ÏñºÎåÄÏÉÅ ‚Üí ÏÇ≠Ï†ú ‚Üí Î≥ÄÍ≤Ω ‚Üí Î≥µÏÇ¨ üîÑ</div>
            </div>
            <div class="header-right">
                <div class="status-badge">
                    <div class="status-dot"></div>
                    Í∞ÄÎèôÏ§ë
                </div>
                <div class="time-badge" id="currentTime">15:32:45</div>
            </div>
        </header>

        <!-- Stage Tabs -->
        <div class="stage-tabs">
            <div class="stage-tab active" data-stage="all">
                <div class="name">Ï†ÑÏ≤¥</div>
                <div class="count" id="countAll">127</div>
            </div>
            <div class="stage-tab" data-stage="1">
                <div class="name">üì§ ÏóÖÎ°úÎìú</div>
                <div class="count" id="count1">15</div>
            </div>
            <div class="stage-tab" data-stage="2">
                <div class="name">üè™ Ïö¥ÏòÅ</div>
                <div class="count" id="count2">89</div>
            </div>
            <div class="stage-tab" data-stage="3">
                <div class="name">üî® Î¶¨Îâ¥ÏñºÎåÄÏÉÅ</div>
                <div class="count" id="count3">8</div>
            </div>
            <div class="stage-tab" data-stage="4">
                <div class="name">üóëÔ∏è ÏÇ≠Ï†ú</div>
                <div class="count" id="count4">6</div>
            </div>
            <div class="stage-tab" data-stage="5">
                <div class="name">‚úèÔ∏è Î≥ÄÍ≤Ω</div>
                <div class="count" id="count5">5</div>
            </div>
            <div class="stage-tab" data-stage="6">
                <div class="name">üìã Î≥µÏÇ¨</div>
                <div class="count" id="count6">4</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="search-box">
                <input type="text" placeholder="Í≥ÑÏ†ïÎ™Ö Í≤ÄÏÉâ..." id="searchInput">
            </div>
            <div class="filter-pills">
                <div class="filter-pill active" data-platform="all">Ï†ÑÏ≤¥</div>
                <div class="filter-pill" data-platform="naver">ÎÑ§Ïù¥Î≤Ñ</div>
                <div class="filter-pill" data-platform="coupang">Ïø†Ìå°</div>
                <div class="filter-pill" data-platform="11st">11Î≤àÍ∞Ä</div>
                <div class="filter-pill" data-platform="gmarket">GÎßàÏºì</div>
            </div>
        </div>

        <!-- PC: Table View -->
        <div class="table-view">
            <div class="table-header">
                <div class="table-header-cell">Ïä§ÌÜ†Ïñ¥Î™Ö</div>
                <div class="table-header-cell">üì§ ÏóÖÎ°úÎìú</div>
                <div class="table-header-cell">üè™ Ïö¥ÏòÅ</div>
                <div class="table-header-cell">üî® Î¶¨Îâ¥ÏñºÎåÄÏÉÅ</div>
                <div class="table-header-cell">üóëÔ∏è ÏÇ≠Ï†ú</div>
                <div class="table-header-cell">‚úèÔ∏è Î≥ÄÍ≤Ω</div>
                <div class="table-header-cell">üìã Î≥µÏÇ¨</div>
                <div class="table-header-cell">üí∞ Î™©ÌëúÎß§Ï∂ú</div>
            </div>
            <div class="table-body" id="tableBody">
            </div>
        </div>

        <!-- Mobile: Card View -->
        <div class="card-view" id="cardView">
        </div>
    </div>

    <script>
        let accounts = [];  // APIÏóêÏÑú Í∞ÄÏ†∏Ïò¨ Îç∞Ïù¥ÌÑ∞

        // APIÏóêÏÑú Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function loadData() {
            try {
                const response = await fetch('/api/bulsaja/dashboard_data');
                const data = await response.json();
                if (data.success) {
                    accounts = data.accounts;
                    renderAll();
                } else {
                    console.error('API Ïò§Î•ò:', data.message);
                }
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        const platformLogos = {
            naver: { letter: 'N', class: 'naver' },
            coupang: { letter: 'C', class: 'coupang' },
            '11st': { letter: '11', class: 'st11' },
            gmarket: { letter: 'G', class: 'gmarket' }
        };

        const stageIcons = ['üì§', 'üè™', 'üî®', 'üóëÔ∏è', '‚úèÔ∏è', 'üìã'];
        const stageNames = ['ÏóÖÎ°úÎìú', 'Ïö¥ÏòÅ', 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ', 'ÏÇ≠Ï†ú', 'Î≥ÄÍ≤Ω', 'Î≥µÏÇ¨'];

        let currentStageFilter = 'all';
        let currentPlatformFilter = 'all';
        let searchQuery = '';

        function formatRevenue(num) {
            if (!num) return '0';
            if (num >= 100000000) return (num / 100000000).toFixed(1) + 'Ïñµ';
            if (num >= 10000000) return (num / 10000000).toFixed(0) + 'Ï≤úÎßå';
            if (num >= 10000) return (num / 10000).toFixed(0) + 'Îßå';
            return num.toLocaleString();
        }

        function getRevenueStatus(revenue, target) {
            const percent = (revenue / target) * 100;
            if (percent >= 100) return 'achieved';
            if (percent >= 50) return 'warning';
            return 'danger';
        }

        function getDaysClass(days) {
            if (days >= 60) return 'danger';
            if (days >= 30) return 'warning';
            return '';
        }

        function renderAll() {
            const filtered = accounts.filter(acc => {
                let matchStage = currentStageFilter === 'all';
                if (!matchStage) {
                    const stageMap = {
                        '1': 'ÏóÖÎ°úÎìú',
                        '2': 'Ïö¥ÏòÅ',
                        '3': 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ',
                        '4': 'ÏÇ≠Ï†ú',
                        '5': 'Î≥ÄÍ≤Ω',
                        '6': 'Î≥µÏÇ¨'
                    };
                    matchStage = acc.stage === stageMap[currentStageFilter];
                }
                const matchPlatform = currentPlatformFilter === 'all' || acc.platform === currentPlatformFilter;
                const matchSearch = acc.name.toLowerCase().includes(searchQuery.toLowerCase());
                return matchStage && matchPlatform && matchSearch;
            });

            // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('countAll').textContent = accounts.length;
            const stageCounts = {
                'ÏóÖÎ°úÎìú': 0, 'Ïö¥ÏòÅ': 0, 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ': 0, 'ÏÇ≠Ï†ú': 0, 'Î≥ÄÍ≤Ω': 0, 'Î≥µÏÇ¨': 0
            };
            accounts.forEach(a => {
                if (stageCounts[a.stage] !== undefined) stageCounts[a.stage]++;
            });
            document.getElementById('count1').textContent = stageCounts['ÏóÖÎ°úÎìú'];
            document.getElementById('count2').textContent = stageCounts['Ïö¥ÏòÅ'];
            document.getElementById('count3').textContent = stageCounts['Î¶¨Îâ¥ÏñºÎåÄÏÉÅ'];
            document.getElementById('count4').textContent = stageCounts['ÏÇ≠Ï†ú'];
            document.getElementById('count5').textContent = stageCounts['Î≥ÄÍ≤Ω'];
            document.getElementById('count6').textContent = stageCounts['Î≥µÏÇ¨'];

            // PC ÌÖåÏù¥Î∏î
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = filtered.map(acc => {
                const logo = platformLogos[acc.platform];
                const cycleClass = acc.cycleCount >= 4 ? 'many' : '';
                const revenuePercent = Math.min((acc.revenue / acc.targetRevenue) * 100, 100);
                const revenueStatus = getRevenueStatus(acc.revenue, acc.targetRevenue);
                const isGaliTarget = acc.stage === 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ';

                const stageMapReverse = {
                    'ÏóÖÎ°úÎìú': 1, 'Ïö¥ÏòÅ': 2, 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ': 3, 'ÏÇ≠Ï†ú': 4, 'Î≥ÄÍ≤Ω': 5, 'Î≥µÏÇ¨': 6
                };
                const currentStageIdx = stageMapReverse[acc.stage] || 0;

                let stageCells = '';
                for (let i = 1; i <= 6; i++) {
                    let stateClass = 'inactive';
                    let content = `<div class="icon">${stageIcons[i - 1]}</div>`;

                    if (i < currentStageIdx) {
                        stateClass = 'completed';
                        content = `<div class="icon">‚úì</div>`;
                    } else if (i === currentStageIdx) {
                        stateClass = 'active';
                        if (i === 2) {
                            const daysClass = getDaysClass(acc.operationDays);
                            content = `<div class="operation-days-container"><div class="operation-days ${daysClass}" onclick="updateOperationDays('${acc.name}', ${acc.operationDays})">${acc.operationDays}Ïùº</div></div>`;
                        } else {
                            content = `<div class="icon">${stageIcons[i - 1]}</div><div class="value">${acc.progress || 0}%</div><div class="progress-bar"><div class="progress-bar-fill" style="width:${acc.progress || 0}%"></div></div>`;
                        }
                    }

                    stageCells += `<div class="stage-cell"><div class="stage-indicator ${stateClass}">${content}</div></div>`;
                }

                let revenueCell = '';
                if (acc.stage === 'Ïö¥ÏòÅ' || acc.stage === 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ') {
                    revenueCell = `
                        <div class="revenue-cell">
                            <div class="revenue-header-row">
                                <span class="revenue-current">${formatRevenue(acc.revenue)}</span>
                                <span class="revenue-target">/ ${formatRevenue(acc.targetRevenue)}</span>
                            </div>
                            <div class="revenue-bar"><div class="revenue-bar-fill ${revenueStatus}" style="width:${revenuePercent}%"></div></div>
                            <div class="revenue-percent ${revenueStatus}">${revenuePercent.toFixed(0)}%${isGaliTarget ? '<span class="gali-tag">Í∞àÏù¥</span>' : ''}</div>
                        </div>`;
                } else {
                    revenueCell = `<div class="revenue-cell"><div style="text-align:center;color:var(--text-muted);font-size:11px">-</div></div>`;
                }

                return `
                        <div class="table-row">
                            <div class="account-cell">
                                <div class="account-logo ${logo.class}">${logo.letter}</div>
                                <div class="account-info">
                                    <h4>${acc.name} ${acc.cycleCount > 0 ? `<span class="cycle-badge ${cycleClass}">${acc.cycleCount}Ìöå</span>` : ''}</h4>
                                    <span>${acc.products.toLocaleString()}Í∞ú</span>
                                </div>
                            </div>
                        ${stageCells}
                        ${revenueCell}
                    </div>`;
            }).join('');

            // Î™®Î∞îÏùº Ïπ¥Îìú
            const cardView = document.getElementById('cardView');
            cardView.innerHTML = filtered.map(acc => {
                const logo = platformLogos[acc.platform];
                const cycleClass = acc.cycleCount >= 4 ? 'many' : '';
                const revenuePercent = Math.min((acc.revenue / acc.targetRevenue) * 100, 100);
                const revenueStatus = getRevenueStatus(acc.revenue, acc.targetRevenue);
                const isGaliTarget = acc.stage === 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ';
                const daysClass = getDaysClass(acc.operationDays);

                let stageContent = '';
                const currentStageIdx = stageMapReverse[acc.stage] || 0;
                if (acc.stage === 'Ïö¥ÏòÅ') {
                    stageContent = `
                        <div class="card-stage-icon active">üè™</div>
                            <div class="card-stage-info">
                                <div class="card-stage-name">Ïö¥ÏòÅÏ§ë</div>
                                <div class="card-stage-value days ${daysClass}" onclick="updateOperationDays('${acc.name}', ${acc.operationDays})">${acc.operationDays}Ïùº</div>
                            </div>`;
                } else {
                    stageContent = `
                                <div class="card-stage-icon active">${stageIcons[currentStageIdx - 1]}</div>
                        <div class="card-stage-info">
                            <div class="card-stage-name">${acc.stage}</div>
                            <div class="card-stage-value">${acc.progress || 0}%</div>
                        </div>
                        <div class="card-progress">
                            <div class="card-progress-bar"><div class="card-progress-bar-fill" style="width:${acc.progress || 0}%"></div></div>
                        </div>`;
                }

                let miniStages = '';
                for (let i = 1; i <= 6; i++) {
                    let cls = '';
                    if (i < currentStageIdx) cls = 'completed';
                    else if (i === currentStageIdx) cls = 'active';
                    miniStages += `<div class="mini-stage ${cls}"></div>`;
                }

                let revenueSection = '';
                if (acc.stage === 'Ïö¥ÏòÅ' || acc.stage === 'Î¶¨Îâ¥ÏñºÎåÄÏÉÅ') {
                    revenueSection = `
                        <div class="card-revenue">
                            <div class="card-revenue-header">
                                <span class="card-revenue-title">üí∞ Î™©ÌëúÎß§Ï∂ú</span>
                                <span class="card-revenue-value ${revenueStatus}">${revenuePercent.toFixed(0)}%${isGaliTarget ? ' üî¥' : ''}</span>
                            </div>
                            <div class="card-revenue-bar"><div class="card-revenue-bar-fill ${revenueStatus}" style="width:${revenuePercent}%"></div></div>
                            <div class="card-revenue-footer">
                                <span>${formatRevenue(acc.revenue)}</span>
                                  <span class="card-revenue-target">/ ${formatRevenue(acc.targetRevenue)}</span>
                            </div>
                        </div>`;
                }

                return `
                        <div class="account-card">
                        <div class="card-header">
                            <div class="account-logo ${logo.class}">${logo.letter}</div>
                            <div class="account-info">
                                <h4>${acc.name} ${acc.cycleCount > 0 ? `<span class="cycle-badge ${cycleClass}">${acc.cycleCount}Ìöå</span>` : ''}</h4>
                                  <span>${acc.products.toLocaleString()}Í∞ú ÏÉÅÌíà</span>
                            </div>
                        </div>
                        <div class="card-stage">${stageContent}</div>
                        ${revenueSection}
                    <div class="card-stages-mini">${miniStages}</div>
                    </div>`;
            }).join('');
        }

        // Ïù¥Î≤§Ìä∏
        document.querySelectorAll('.stage-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.stage-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentStageFilter = this.dataset.stage;
                renderAll();
            });
        });

        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.addEventListener('click', function () {
                document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                currentPlatformFilter = this.dataset.platform;
                renderAll();
            });
        });

        document.getElementById('searchInput').addEventListener('input', function () {
            searchQuery = this.value;
            renderAll();
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toTimeString().slice(0, 8);
        }
        setInterval(updateTime, 1000);

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function updateOperationDays(storeName, currentDays) {
            const newDays = prompt(`${storeName}Ïùò Ïö¥ÏòÅÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:`, currentDays);
            if (newDays === null) return;

            const days = parseInt(newDays);
            if (isNaN(days)) {
                alert('Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }

            try {
                const res = await fetch('/api/bulsaja/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        store_name: storeName,
                        operationDays: days
                    })
                });
                const data = await res.json();
                if (data.success) {
                    // Í∏∞Í∏∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Î¶¨Î†åÎçîÎßÅ
                    const acc = accounts.find(a => a.name === storeName);
                    if (acc) {
                        acc.operationDays = days;
                        renderAll();
                    }
                } else {
                    alert('Ï†ÄÏû• Ïã§Ìå®: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('ÌÜµÏã† Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        loadData();
        updateTime();
    </script>
</body>

</html>